<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Supabase Realtime Test - Lobby</title>
</head>
<body>
  <h1>Supabase Realtime Test - Lobby</h1>
  <div id="user-info">Bienvenido, Usuario | Fichas: 0</div>
  <button id="update-fichas-btn">Actualizar Fichas</button>
  <div id="logs" style="margin-top: 20px; padding: 10px; border: 1px solid #ccc; max-height: 300px; overflow-y: auto;">
    <h3>Logs:</h3>
  </div>

  <!-- Ruta relativa al archivo JS -->
  <script type="module" src="./js/realtime-test-lobby.js"></script>
</body>
</html>



<!--//aqui comienza el archivo js va serpado pero lo junte en este archivo-->
<script>
// Importar el cliente de Supabase
import { supabase } from './supabase.js';

// Referencia al contenedor de logs
const logsDiv = document.getElementById('logs');

// Función para registrar mensajes en el área de logs
function logMessage(message) {
  const logEntry = document.createElement('div');
  logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
  logsDiv.appendChild(logEntry);
  logsDiv.scrollTop = logsDiv.scrollHeight; // Auto-scroll al final
}

// Suscribirse a eventos Realtime para el usuario con UUID específico
const channel = supabase
  .channel('usuarios-realtime')
  .on(
    'postgres_changes',
    { event: 'UPDATE', schema: 'public', table: 'usuarios', filter: `id=eq.720dd45a-b831-40e1-b012-e4a199923bc9` },
    (payload) => {
      logMessage(`Realtime Event: ${payload.eventType}, Data: ${JSON.stringify(payload.new)}`);
      actualizarFichas(payload.new);
    }
  )
  .subscribe();

// Función para actualizar las fichas del usuario en el lobby
function actualizarFichas(usuario) {
  const userInfo = document.getElementById('user-info');
  if (userInfo && usuario) {
    userInfo.textContent = `Bienvenido, ${usuario.nombre_usuario || 'Usuario'} | Fichas: ${usuario.fichas || 0}`;
    logMessage(`User Info Updated: ${JSON.stringify(usuario)}`);
  } else {
    logMessage('Error: No se pudo actualizar el elemento #user-info o los datos del usuario son inválidos.');
  }
}

// Botón para simular una actualización de fichas
document.getElementById('update-fichas-btn').addEventListener('click', async () => {
  const usuarioId = '720dd45a-b831-40e1-b012-e4a199923bc9'; // UUID del usuario
  const nuevasFichas = Math.floor(Math.random() * 100); // Generar un número aleatorio de fichas

  const { data, error } = await supabase
    .from('usuarios')
    .update({ fichas: nuevasFichas })
    .eq('id', usuarioId)
    .select();

  if (error) {
    logMessage(`Update Error: ${error.message}`);
  } else {
    logMessage(`Updated Fichas: ${JSON.stringify(data)}`);
  }
});

// Obtener los datos iniciales del usuario al cargar la página
(async () => {
  const usuarioId = '720dd45a-b831-40e1-b012-e4a199923bc9'; // UUID del usuario
  const { data, error } = await supabase
    .from('usuarios')
    .select('nombre_usuario, fichas')
    .eq('id', usuarioId)
    .single();

  if (error) {
    logMessage(`Error al obtener los datos iniciales del usuario: ${error.message}`);
  } else if (data) {
    actualizarFichas(data);
    logMessage(`Datos iniciales del usuario cargados: ${JSON.stringify(data)}`);
  }
})();