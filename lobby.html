<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Lobby - Juega Virtual Argentina</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
  <div class="lobby-container">
    <header>
      <h1>Juega Virtual Argentina</h1>
      <div id="user-info"></div>
      <button id="logout-btn">Cerrar sesi칩n</button>
    </header>

    <section>
      <h2>Mesas disponibles</h2>
      <div id="mesas-container"></div>
      <button id="crear-mesa-btn">Crear nueva mesa</button>
    </section>

    <section>
      <h2>Juegos individuales</h2>
      <a href="juegos/tragamonedas/index.html" class="juego-link">游꿣 Tragamonedas</a>
    </section>
  </div>

  <script type="module">
    import { verificarSesion } from './js/session.js';
    import { logout as cerrarSesion } from './js/auth.js';
    import { obtenerMesas, crearMesa, unirseAMesa } from './js/mesas.js';

    const userInfo = document.getElementById('user-info');
    const logoutBtn = document.getElementById('logout-btn');
    const mesasContainer = document.getElementById('mesas-container');
    const crearMesaBtn = document.getElementById('crear-mesa-btn');

    let usuario;

    try {
      usuario = await verificarSesion();
      userInfo.textContent = `Bienvenido, ${usuario.nombre_usuario} | Fichas: ${usuario.fichas}`;
      cargarMesas();
    } catch (e) {
      window.location.href = 'login.html';
    }

    async function cargarMesas() {
      mesasContainer.innerHTML = '';
      const mesas = await obtenerMesas();
      if (mesas.length === 0) {
        mesasContainer.textContent = 'No hay mesas disponibles por ahora.';
        return;
      }

      mesas.forEach(mesa => {
        const jugadoresActuales = mesa.jugadores ? mesa.jugadores.length : 0;

        const div = document.createElement('div');
        div.className = 'mesa';
        div.innerHTML = `
          <strong>Nombre de mesa: ${mesa.nombre_mesa}</strong><br/>
          Creador: ${mesa.creador?.nombre_usuario || 'Desconocido'}<br/>
          Apuesta: ${mesa.fichas_apuesta} fichas<br/>
          Jugadores: ${jugadoresActuales}/${mesa.max_jugadores}<br/>
          Estado: ${mesa.estado}<br/>
          <button data-id="${mesa.id}">Unirse</button>
        `;

        div.querySelector('button').addEventListener('click', async () => {
          const { error } = await unirseAMesa(mesa.id);
          if (error) {
            alert(error);
            if (error === 'La mesa est치 llena.') {
              cargarMesas(); // Actualizar el lobby si la mesa est치 llena
            }
          } else {
            alert('Te has unido a la mesa.');
            cargarMesas(); // Actualizar el lobby despu칠s de unirse
          }
        });

        mesasContainer.appendChild(div);
      });
    }

    crearMesaBtn.addEventListener('click', async () => {
      const nombre = prompt("Nombre de la nueva mesa:");
      const apuesta = parseInt(prompt("Cantidad de fichas por jugador:"));
      const maxJugadores = parseInt(prompt("M치ximo de jugadores en la mesa:"));

      if (nombre && apuesta > 0 && maxJugadores > 1) {
        const { data: mesa, error } = await crearMesa(nombre, apuesta, maxJugadores);
        if (error) {
          alert(error);
        } else {
          alert('Mesa creada correctamente.');
          cargarMesas(); // Actualizar el lobby
        }
      } else {
        alert("Datos inv치lidos para crear la mesa.");
      }
    });

    logoutBtn.addEventListener('click', async () => {
      await cerrarSesion();
    });

    // Actualizar el lobby din치micamente cada 5 segundos
    setInterval(cargarMesas, 5000);
  </script>
</body>
</html>